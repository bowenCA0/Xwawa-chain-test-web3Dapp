"use strict";var web3,lotteryContract,userAccount,isConnected=!1,drawTimes=1,drawCost=1e4,isSpinning=!1,prizes=[{id:1,name:"一等奖",probability:.01,color:"#FF6B6B",className:"first-prize"},{id:2,name:"二等奖",probability:.05,color:"#4ECDC4",className:"second-prize"},{id:3,name:"三等奖",probability:.1,color:"#FFD166",className:"third-prize"},{id:4,name:"奖池分红",probability:.15,color:"#06D6A0",className:"pool-prize"},{id:5,name:"双倍抽奖",probability:.2,color:"#118AB2",className:"double"},{id:6,name:"谢谢参与",probability:.49,color:"#073B4C",className:"nothing"}],lotteryABI=[{inputs:[{internalType:"uint256",name:"_times",type:"uint256"}],name:"draw",outputs:[{internalType:"uint8[]",name:"winningType",type:"uint8[]"}],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"drawCost",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}],lotteryContractAddress="0x1234567890123456789012345678901234567890",xwawaTokenAddress="0x0987654321098765432109876543210987654321";function closeResultModal(){var e=document.getElementById("result-modal");e&&(e.style.display="none")}function initLanguageSwitch(){var e=document.getElementById("language-switch");if(e){e.addEventListener("change",function(){var e=this.checked?"en":"zh";switchLanguage(e),localStorage.setItem("preferred-language",e)});var t=localStorage.getItem("preferred-language")||"zh";e.checked="en"===t,switchLanguage(t)}}function switchLanguage(t){document.querySelectorAll("[data-lang-zh], [data-lang-en]").forEach(function(e){"zh"===t?e.hasAttribute("data-lang-zh")&&(e.textContent=e.getAttribute("data-lang-zh")):e.hasAttribute("data-lang-en")&&(e.textContent=e.getAttribute("data-lang-en"))})}function checkWalletConnection(){var t,n,r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(window.ethereum)return e.prev=1,e.next=4,regeneratorRuntime.awrap(window.ethereum.request({method:"eth_accounts"}));e.next=27;break;case 4:if(0<(t=e.sent).length)return userAccount=t[0],web3=new Web3(window.ethereum),e.prev=8,e.next=11,regeneratorRuntime.awrap(window.ContractConfig.loadLotteryAbi());e.next=22;break;case 11:n=e.sent,(r=window.ContractConfig.lotteryAddress)?lotteryContract=new web3.eth.Contract(n,r):console.error("Lottery合约地址未配置，请在 js/contract-config.js 中填写 lotteryAddress"),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(8),console.error("加载Lottery ABI失败:",e.t0);case 19:return isConnected=!0,e.next=22,regeneratorRuntime.awrap(updateDrawCostFromContract());case 22:e.next=27;break;case 24:e.prev=24,e.t1=e.catch(1),console.error("检查钱包连接失败:",e.t1);case 27:case"end":return e.stop()}},null,null,[[1,24],[8,16]])}function connectWallet(){var t,n,r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,window.ethereum)return console.log("Web3钱包已检测到"),e.next=5,regeneratorRuntime.awrap(window.ethereum.request({method:"eth_requestAccounts"}));e.next=27;break;case 5:return t=e.sent,userAccount=t[0],web3=new Web3(window.ethereum),e.prev=8,e.next=11,regeneratorRuntime.awrap(window.ContractConfig.loadLotteryAbi());case 11:n=e.sent,(r=window.ContractConfig.lotteryAddress)?lotteryContract=new web3.eth.Contract(n,r):console.error("Lottery合约地址未配置，请在 js/contract-config.js 中填写 lotteryAddress"),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(8),console.error("加载Lottery ABI失败:",e.t0);case 19:return e.next=21,regeneratorRuntime.awrap(updateDrawCostFromContract());case 21:window.ethereum.on("accountsChanged",handleAccountsChanged),window.ethereum.on("chainChanged",handleChainChanged),isConnected=!0,console.log("钱包连接成功:",userAccount),e.next=29;break;case 27:alert("请安装MetaMask钱包以使用抽奖功能！"),window.open("https://metamask.io/download/","_blank");case 29:e.next=36;break;case 31:e.prev=31,e.t1=e.catch(0),console.error("连接钱包失败:",e.t1),4001===e.t1.code?alert("用户拒绝了钱包连接请求"):-32002===e.t1.code?alert("钱包连接请求已在处理中，请检查MetaMask"):alert("连接钱包时发生错误，请重试"),isConnected=!1;case 36:case"end":return e.stop()}},null,null,[[0,31],[8,16]])}function updateDrawCostFromContract(){var t,n,r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(lotteryContract.methods.drawCost().call());case 3:t=e.sent,drawCost=web3.utils.fromWei(t,"ether"),console.log("合约抽奖成本:",drawCost),(n=document.getElementById("cost-amount"))&&(n.textContent=drawCost),updateTotalCost(),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("获取抽奖成本失败:",e.t0),(r=document.getElementById("cost-amount"))&&(r.textContent=drawCost);case 16:case"end":return e.stop()}},null,null,[[0,11]])}function handleAccountsChanged(e){0===e.length?(isConnected=!1,userAccount=null,console.log("钱包已断开连接")):(userAccount=e[0],console.log("账户已切换:",userAccount))}function handleChainChanged(e){console.log("网络已切换:",e),window.location.reload()}function updateDrawTimes(e){var t=document.getElementById("draw-times-input"),n=parseInt(t.value)+e;n<1&&(n=1),100<n&&(n=100),t.value=n,drawTimes=n,updateTotalCost()}function validateDrawTimes(){var e=document.getElementById("draw-times-input"),t=parseInt(e.value);isNaN(t)||t<1?t=1:100<t&&(t=100),e.value=t,drawTimes=t,updateTotalCost()}function updateTotalCost(){var e=drawTimes*drawCost,t=document.getElementById("total-cost-amount");t&&(t.textContent=e)}function startDraw(){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(isConnected){e.next=3;break}return alert("请先连接钱包"),e.abrupt("return");case 3:if(isSpinning)return e.abrupt("return");e.next=5;break;case 5:return isSpinning=!0,(t=document.getElementById("draw-button"))&&(t.disabled=!0,t.textContent="抽奖中..."),e.prev=8,e.next=11,regeneratorRuntime.awrap(drawFromContract(drawTimes));case 11:e.sent,startMagicAnimation(),playSpinSound(),n=prizes[Math.floor(Math.random()*prizes.length)],spinWheel(n.id),setTimeout(function(){n.id<=4&&addWinEffect(n.id),showResultModal(n),addResultsToList([n]),resetDrawState()},5200),e.next=24;break;case 19:e.prev=19,e.t0=e.catch(8),console.error("抽奖失败:",e.t0),alert("抽奖失败，请重试"),resetDrawState();case 24:case"end":return e.stop()}},null,null,[[8,19]])}function resetDrawState(){isSpinning=!1;var e=document.getElementById("draw-button");e&&(e.disabled=!1,e.textContent="开始抽奖")}function getUserTokenBalance(){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(getXwawaContract());case 3:return t=e.sent,e.next=6,regeneratorRuntime.awrap(t.methods.balanceOf(userAccount).call());case 6:return n=e.sent,e.abrupt("return",parseFloat(web3.utils.fromWei(n,"ether")));case 10:return e.prev=10,e.t0=e.catch(0),console.error("获取用户余额失败:",e.t0),e.abrupt("return",0);case 14:case"end":return e.stop()}},null,null,[[0,10]])}function updateUI(){var e=document.getElementById("wallet-status"),t=document.getElementById("connect-wallet-btn"),n=document.getElementById("draw-button");isConnected?(e.textContent="已连接: ".concat(shortenAddress(userAccount)),e.className="connected",t.textContent="已连接",t.disabled=!0,n.disabled=!1):(e.textContent="未连接钱包",e.className="not-connected",t.textContent="连接钱包",t.disabled=!1,n.disabled=!0),document.getElementById("cost-amount").textContent=drawCost,updateTotalCost()}function shortenAddress(e){return"".concat(e.substring(0,6),"...").concat(e.substring(e.length-4))}function generateMockResults(){for(var e=[],t=0;t<drawTimes;t++){var n=r();e.push(n),0===t&&a(n.id)}!function(e){var n=document.querySelector(".results-list"),t=document.querySelector(".no-results");t&&(t.style.display="none");e.forEach(function(e){var t=document.createElement("div");t.className="result-item ".concat(e.className),t.innerHTML='\n            <span class="result-name">'.concat(e.name,'</span>\n            <span class="result-value">').concat((new Date).toLocaleTimeString(),"</span>\n        "),n.prepend(t)})}(e),1===drawTimes&&setTimeout(function(){!function(e){var t=document.getElementById("result-modal"),n=document.getElementById("result-title"),r=document.getElementById("result-message"),a=document.getElementById("result-icon");n.textContent="恭喜获得: ".concat(e.name),r.textContent=function(e){switch(e){case 1:return"恭喜您获得一等奖！奖励已发放到您的账户。";case 2:return"恭喜您获得二等奖！奖励已发放到您的账户。";case 3:return"恭喜您获得三等奖！奖励已发放到您的账户。";case 4:return"您获得了奖池分红！奖励已发放到您的账户。";case 5:return"您获得了双倍抽奖机会！下次抽奖将获得双倍奖励。";case 6:return"谢谢参与，下次再接再厉！";default:return"抽奖结果未知，请联系客服。"}}(e.id),a.textContent=function(e){switch(e){case 1:return"🏆";case 2:return"🥈";case 3:return"🥉";case 4:return"💰";case 5:return"🎯";case 6:return"😊";default:return"❓"}}(e.id),a.style.color=e.color,t.style.display="block"}(e[0])},5500),console.log("抽奖完成，结果:",e);try{console.error("抽奖失败:",error),alert("抽奖失败，请重试"),isSpinning=!1,document.getElementById("draw-button").disabled=!1}catch(e){console.error("抽奖失败:",e),alert("抽奖失败，请重试"),isSpinning=!1,document.getElementById("draw-button").disabled=!1}function r(){for(var e=Math.random(),t=0,n=0,r=prizes;n<r.length;n++){var a=r[n];if(e<=(t+=a.probability))return a}return prizes[prizes.length-1]}function a(e){var t=document.querySelector(".wheel-inner"),n=document.querySelector(".lottery-wheel-container"),r=document.querySelector(".wheel-pointer"),a=document.querySelector(".wheel-magic-aura");n.classList.add("spinning","magic-spinning"),r.classList.add("pointer-active"),a&&a.classList.add("spinning-aura");var o=360-(60*(e-1)+30)+360*(8+4*Math.random());t.style.transition="transform 5s cubic-bezier(0.23, 1, 0.32, 1)",t.style.transform="rotate(".concat(o,"deg)"),function(){try{var e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(200,e.currentTime),t.frequency.exponentialRampToValueAtTime(100,e.currentTime+.1),n.gain.setValueAtTime(.1,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)}catch(e){console.log("Audio not supported")}}(),"vibrate"in navigator&&navigator.vibrate([100,50,100]),createSpinningMagicParticles(),setTimeout(function(){n.classList.add("mid-spin","magic-burst"),createMagicEnergyWave()},2500),setTimeout(function(){isSpinning=!1,n.classList.remove("spinning","mid-spin","magic-spinning","magic-burst"),r.classList.remove("pointer-active"),n.classList.add("spin-complete"),a&&a.classList.remove("spinning-aura"),function(e){var t=document.querySelector(".lottery-wheel-container");e<=3?(t.classList.add("major-win"),function(){for(var t=document.querySelector(".lottery-wheel-container"),e=0;e<20;e++)setTimeout(function(){var e=document.createElement("div");e.className="firework-particle",e.style.left=100*Math.random()+"%",e.style.top=100*Math.random()+"%",t.appendChild(e),setTimeout(function(){e.remove()},1e3)},100*e)}(),setTimeout(function(){t.classList.remove("major-win")},3e3)):e<=5&&(t.classList.add("minor-win"),setTimeout(function(){t.classList.remove("minor-win")},2e3))}(e),document.getElementById("draw-button").disabled=!1,setTimeout(function(){n.classList.remove("spin-complete")},1e3)},5e3)}}function drawFromContract(t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(lotteryContract.methods.draw(t).send({from:userAccount}));case 3:return n=e.sent,e.abrupt("return",n);case 7:throw e.prev=7,e.t0=e.catch(0),console.error("合约抽奖失败:",e.t0),e.t0;case 11:case"end":return e.stop()}},null,null,[[0,7]])}function getXwawaContract(){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(lotteryContract.methods.XWAWA_COIN().call());case 3:return t=e.sent,n=[{constant:!0,inputs:[{name:"_owner",type:"address"}],name:"balanceOf",outputs:[{name:"balance",type:"uint256"}],type:"function"},{constant:!1,inputs:[{name:"_spender",type:"address"},{name:"_value",type:"uint256"}],name:"approve",outputs:[{name:"",type:"bool"}],type:"function"}],e.abrupt("return",new web3.eth.Contract(n,t));case 8:throw e.prev=8,e.t0=e.catch(0),console.error("获取Xwawa合约失败:",e.t0),e.t0;case 12:case"end":return e.stop()}},null,null,[[0,8]])}function startMagicAnimation(){var e=document.querySelector(".magic-wizard"),t=document.querySelector(".magic-wand"),n=document.querySelector("#magic-arm"),r=document.querySelector(".magic-particles"),a=document.querySelector(".magic-spell"),o=document.querySelector(".wheel-magic-aura");e&&(e.classList.add("casting"),a&&(a.style.opacity="1",a.style.transform="translateY(-10px)"),setTimeout(function(){n&&n.classList.add("casting"),t&&t.classList.add("waving"),r&&r.classList.add("active"),playMagicSound()},500),setTimeout(function(){o&&o.classList.add("active"),createMagicBurst()},1e3),setTimeout(function(){resetMagicAnimation()},6e3))}function resetMagicAnimation(){var e=document.querySelector(".magic-wizard"),t=document.querySelector(".magic-wand"),n=document.querySelector("#magic-arm"),r=document.querySelector(".magic-particles"),a=document.querySelector(".magic-spell"),o=document.querySelector(".wheel-magic-aura");e&&e.classList.remove("casting"),t&&t.classList.remove("waving"),n&&n.classList.remove("casting"),r&&r.classList.remove("active"),o&&o.classList.remove("active"),a&&(a.style.opacity="0",a.style.transform="translateY(0)")}function playMagicSound(){try{var r=new(window.AudioContext||window.webkitAudioContext);[440,554,659,880].forEach(function(n,e){setTimeout(function(){var e=r.createOscillator(),t=r.createGain();e.connect(t),t.connect(r.destination),e.frequency.setValueAtTime(n,r.currentTime),e.type="sine",t.gain.setValueAtTime(0,r.currentTime),t.gain.linearRampToValueAtTime(.1,r.currentTime+.1),t.gain.exponentialRampToValueAtTime(.01,r.currentTime+.5),e.start(r.currentTime),e.stop(r.currentTime+.5)},150*e)})}catch(e){console.log("Magic audio not supported")}}function createMagicBurst(){var c=document.querySelector(".lottery-wheel-container");if(c)for(var e=0;e<30;e++)setTimeout(function(){var e=document.createElement("div");e.className="magic-burst-particle";var t=["#FFD700","#FF69B4","#00FFFF","#FF6347","#98FB98"];e.style.background=t[Math.floor(Math.random()*t.length)],e.style.left=50+60*(Math.random()-.5)+"%",e.style.top=50+60*(Math.random()-.5)+"%";var n=Math.random()*Math.PI*2,r=100+100*Math.random(),a=Math.cos(n)*r,o=Math.sin(n)*r;e.style.setProperty("--end-x",a+"px"),e.style.setProperty("--end-y",o+"px"),c.appendChild(e),setTimeout(function(){e.style.transform="translate(var(--end-x), var(--end-y)) scale(0)",e.style.opacity="0"},50),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},2e3)},50*e)}function createSpinningMagicParticles(){var c=document.querySelector(".lottery-wheel-container");if(c)for(var e=function(o){setTimeout(function(){var e=document.createElement("div");e.className="spinning-magic-particle";var t=["#FFD700","#FF69B4","#00FFFF","#9370DB","#FF6347"];e.style.background=t[Math.floor(Math.random()*t.length)];var n=o/20*Math.PI*2,r=50+150*Math.cos(n)/4,a=50+150*Math.sin(n)/4;e.style.left=r+"%",e.style.top=a+"%",e.style.setProperty("--orbit-angle",n+"rad"),c.appendChild(e),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},5e3)},100*o)},t=0;t<20;t++)e(t)}function createMagicEnergyWave(){var n=document.querySelector(".lottery-wheel-container");if(n)for(var e=function(t){setTimeout(function(){var e=document.createElement("div");e.className="magic-energy-wave";e.style.borderColor=["#FFD700","#FF69B4","#00FFFF"][t],e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)",n.appendChild(e),setTimeout(function(){e.style.width="400px",e.style.height="400px",e.style.opacity="0"},50),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},1500)},300*t)},t=0;t<3;t++)e(t)}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("draw-button"),t=document.getElementById("draw-times-minus"),n=document.getElementById("draw-times-plus"),r=document.getElementById("draw-times-input");e&&e.addEventListener("click",startDraw),t&&t.addEventListener("click",function(){return updateDrawTimes(-1)}),n&&n.addEventListener("click",function(){return updateDrawTimes(1)}),r&&r.addEventListener("change",validateDrawTimes),document.querySelectorAll(".close-modal, .close-result-btn").forEach(function(e){e.addEventListener("click",closeResultModal)}),initLanguageSwitch(),checkWalletConnection(),"undefined"!=typeof WalletManager&&(new WalletManager).init()});
//# sourceMappingURL=lottery.min.js.map
