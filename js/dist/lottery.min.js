"use strict";var web3,lotteryContract,userAccount,isConnected=!1,drawTimes=1,drawCost=1e4,isSpinning=!1,prizes=[{id:1,name:"一等奖",probability:.01,color:"#FF6B6B",className:"first-prize"},{id:2,name:"二等奖",probability:.05,color:"#4ECDC4",className:"second-prize"},{id:3,name:"三等奖",probability:.1,color:"#FFD166",className:"third-prize"},{id:4,name:"奖池分红",probability:.15,color:"#06D6A0",className:"pool-prize"},{id:5,name:"双倍抽奖",probability:.2,color:"#118AB2",className:"double"},{id:6,name:"谢谢参与",probability:.49,color:"#073B4C",className:"nothing"}],lotteryABI=[{inputs:[],name:"draw",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"drawCost",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}],lotteryContractAddress="0x1234567890123456789012345678901234567890",xwawaTokenAddress="0x0987654321098765432109876543210987654321";function initLanguageSwitch(){var e=document.getElementById("language-switch");if(e){e.addEventListener("change",function(){var e=this.checked?"en":"zh";switchLanguage(e),localStorage.setItem("preferred-language",e)});var t=localStorage.getItem("preferred-language")||"zh";e.checked="en"===t,switchLanguage(t)}}function switchLanguage(t){document.querySelectorAll("[data-lang-zh], [data-lang-en]").forEach(function(e){"zh"===t?e.hasAttribute("data-lang-zh")&&(e.textContent=e.getAttribute("data-lang-zh")):e.hasAttribute("data-lang-en")&&(e.textContent=e.getAttribute("data-lang-en"))})}function checkWalletConnection(){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(window.ethereum)return e.prev=1,e.next=4,regeneratorRuntime.awrap(window.ethereum.request({method:"eth_accounts"}));e.next=18;break;case 4:if(0<(t=e.sent).length)return userAccount=t[0],web3=new Web3(window.ethereum),lotteryContract=new web3.eth.Contract(lotteryABI,lotteryContractAddress),isConnected=!0,updateUI(),e.next=13,regeneratorRuntime.awrap(updateDrawCostFromContract());e.next=13;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(1),console.error("检查钱包连接失败:",e.t0);case 18:case"end":return e.stop()}},null,null,[[1,15]])}function connectWallet(){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,window.ethereum)return console.log("Web3钱包已检测到"),e.next=5,regeneratorRuntime.awrap(window.ethereum.request({method:"eth_requestAccounts"}));e.next=18;break;case 5:return t=e.sent,userAccount=t[0],web3=new Web3(window.ethereum),lotteryContract=new web3.eth.Contract(lotteryABI,lotteryContractAddress),e.next=11,regeneratorRuntime.awrap(updateDrawCostFromContract());case 11:window.ethereum.on("accountsChanged",handleAccountsChanged),window.ethereum.on("chainChanged",handleChainChanged),isConnected=!0,updateUI(),console.log("钱包连接成功:",userAccount),e.next=20;break;case 18:alert("请安装MetaMask钱包以使用抽奖功能！"),window.open("https://metamask.io/download/","_blank");case 20:e.next=28;break;case 22:e.prev=22,e.t0=e.catch(0),console.error("连接钱包失败:",e.t0),4001===e.t0.code?alert("用户拒绝了钱包连接请求"):-32002===e.t0.code?alert("钱包连接请求已在处理中，请检查MetaMask"):alert("连接钱包时发生错误，请重试"),isConnected=!1,updateUI();case 28:case"end":return e.stop()}},null,null,[[0,22]])}function updateDrawCostFromContract(){var t,n,r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(lotteryContract.methods.drawCost().call());case 3:t=e.sent,drawCost=web3.utils.fromWei(t,"ether"),console.log("合约抽奖成本:",drawCost),(n=document.getElementById("cost-amount"))&&(n.textContent=drawCost),updateTotalCost(),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("获取抽奖成本失败:",e.t0),(r=document.getElementById("cost-amount"))&&(r.textContent=drawCost);case 16:case"end":return e.stop()}},null,null,[[0,11]])}function handleAccountsChanged(e){0===e.length?(isConnected=!1,userAccount=null,console.log("钱包已断开连接")):(userAccount=e[0],console.log("账户已切换:",userAccount)),updateUI()}function handleChainChanged(e){console.log("网络已切换:",e),window.location.reload()}function updateDrawTimes(e){var t=document.getElementById("draw-times-input"),n=parseInt(t.value)+e;n<1&&(n=1),100<n&&(n=100),t.value=n,drawTimes=n,updateTotalCost()}function validateDrawTimes(){var e=document.getElementById("draw-times-input"),t=parseInt(e.value);isNaN(t)||t<1?t=1:100<t&&(t=100),e.value=t,drawTimes=t,updateTotalCost()}function updateTotalCost(){var e=drawTimes*drawCost,t=document.getElementById("total-cost-amount");t&&(t.textContent=e)}function startDraw(){var t,n,r,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(isConnected){e.next=3;break}return alert("请先连接钱包"),e.abrupt("return");case 3:if(isSpinning)return e.abrupt("return");e.next=5;break;case 5:return isSpinning=!0,(t=document.getElementById("draw-button"))&&(t.disabled=!0,t.textContent="抽奖中..."),e.prev=8,n=drawTimes*drawCost,e.next=12,regeneratorRuntime.awrap(getUserTokenBalance());case 12:if((r=e.sent)<n)return alert("余额不足！需要 ".concat(n," XWAWA，当前余额 ").concat(r," XWAWA")),e.abrupt("return");e.next=16;break;case 16:return e.next=18,regeneratorRuntime.awrap(drawFromContract());case 18:a=e.sent,playSpinSound(),0<a.length&&spinWheel(a[0].id),setTimeout(function(){0<a.length&&a[0].id<=4&&addWinEffect(a[0].id),showResultModal(a),addResultsToList(a),resetDrawState()},3e3),e.next=29;break;case 24:e.prev=24,e.t0=e.catch(8),console.error("抽奖失败:",e.t0),alert("抽奖失败，请重试"),resetDrawState();case 29:case"end":return e.stop()}},null,null,[[8,24]])}function resetDrawState(){isSpinning=!1;var e=document.getElementById("draw-button");e&&(e.disabled=!1,e.textContent="开始抽奖")}function getUserTokenBalance(){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(getXwawaContract());case 3:return t=e.sent,e.next=6,regeneratorRuntime.awrap(t.methods.balanceOf(userAccount).call());case 6:return n=e.sent,e.abrupt("return",parseFloat(web3.utils.fromWei(n,"ether")));case 10:return e.prev=10,e.t0=e.catch(0),console.error("获取用户余额失败:",e.t0),e.abrupt("return",0);case 14:case"end":return e.stop()}},null,null,[[0,10]])}function generateMockResults(){for(var e=[],t=0;t<drawTimes;t++){var n=r();e.push(n),0===t&&a(n.id)}!function(e){var n=document.querySelector(".results-list"),t=document.querySelector(".no-results");t&&(t.style.display="none");e.forEach(function(e){var t=document.createElement("div");t.className="result-item ".concat(e.className),t.innerHTML='\n            <span class="result-name">'.concat(e.name,'</span>\n            <span class="result-value">').concat((new Date).toLocaleTimeString(),"</span>\n        "),n.prepend(t)})}(e),1===drawTimes&&setTimeout(function(){!function(e){var t=document.getElementById("result-modal"),n=document.getElementById("result-title"),r=document.getElementById("result-message"),a=document.getElementById("result-icon");n.textContent="恭喜获得: ".concat(e.name),r.textContent=function(e){switch(e){case 1:return"恭喜您获得一等奖！奖励已发放到您的账户。";case 2:return"恭喜您获得二等奖！奖励已发放到您的账户。";case 3:return"恭喜您获得三等奖！奖励已发放到您的账户。";case 4:return"您获得了奖池分红！奖励已发放到您的账户。";case 5:return"您获得了双倍抽奖机会！下次抽奖将获得双倍奖励。";case 6:return"谢谢参与，下次再接再厉！";default:return"抽奖结果未知，请联系客服。"}}(e.id),a.textContent=function(e){switch(e){case 1:return"🏆";case 2:return"🥈";case 3:return"🥉";case 4:return"💰";case 5:return"🎯";case 6:return"😊";default:return"❓"}}(e.id),a.style.color=e.color,t.style.display="block"}(e[0])},5500),console.log("抽奖完成，结果:",e);try{console.error("抽奖失败:",error),alert("抽奖失败，请重试"),isSpinning=!1,document.getElementById("draw-button").disabled=!1}catch(e){console.error("抽奖失败:",e),alert("抽奖失败，请重试"),isSpinning=!1,document.getElementById("draw-button").disabled=!1}function r(){for(var e=Math.random(),t=0,n=0,r=prizes;n<r.length;n++){var a=r[n];if(e<=(t+=a.probability))return a}return prizes[prizes.length-1]}function a(e){var t=document.querySelector(".wheel-inner"),n=document.querySelector(".lottery-wheel-container"),r=document.querySelector(".wheel-pointer");n.classList.add("spinning"),r.classList.add("pointer-active");var a=360-(60*(e-1)+30)+360*(6+2*Math.random());t.style.transition="transform 4s cubic-bezier(0.25, 0.46, 0.45, 0.94)",t.style.transform="rotate(".concat(a,"deg)"),function(){try{var e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(200,e.currentTime),t.frequency.exponentialRampToValueAtTime(100,e.currentTime+.1),n.gain.setValueAtTime(.1,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)}catch(e){console.log("Audio not supported")}}(),"vibrate"in navigator&&navigator.vibrate([100,50,100]),setTimeout(function(){n.classList.add("mid-spin")},2e3),setTimeout(function(){isSpinning=!1,n.classList.remove("spinning","mid-spin"),r.classList.remove("pointer-active"),n.classList.add("spin-complete"),function(e){var t=document.querySelector(".lottery-wheel-container");e<=3?(t.classList.add("major-win"),function(){for(var t=document.querySelector(".lottery-wheel-container"),e=0;e<20;e++)setTimeout(function(){var e=document.createElement("div");e.className="firework-particle",e.style.left=100*Math.random()+"%",e.style.top=100*Math.random()+"%",t.appendChild(e),setTimeout(function(){e.remove()},1e3)},100*e)}(),setTimeout(function(){t.classList.remove("major-win")},3e3)):e<=5&&(t.classList.add("minor-win"),setTimeout(function(){t.classList.remove("minor-win")},2e3))}(e),document.getElementById("draw-button").disabled=!1,setTimeout(function(){n.classList.remove("spin-complete")},1e3)},4e3)}}function drawFromContract(){var t,n,r,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(getXwawaContract());case 3:return t=e.sent,e.next=6,regeneratorRuntime.awrap(t.methods.balanceOf(userAccount).call());case 6:if(n=e.sent,r=web3.utils.toWei((drawCost*drawTimes).toString(),"ether"),parseInt(n)<parseInt(r))return alert("Xwawa代币余额不足，请充值后再试"),e.abrupt("return",null);e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(t.methods.approve(lotteryContractAddress,r).send({from:userAccount}));case 13:return e.next=15,regeneratorRuntime.awrap(lotteryContract.methods.draw().send({from:userAccount}));case 15:return a=e.sent,e.abrupt("return",a);case 19:throw e.prev=19,e.t0=e.catch(0),console.error("合约抽奖失败:",e.t0),e.t0;case 23:case"end":return e.stop()}},null,null,[[0,19]])}function getXwawaContract(){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(lotteryContract.methods.XWAWA_COIN().call());case 3:return t=e.sent,n=[{constant:!0,inputs:[{name:"_owner",type:"address"}],name:"balanceOf",outputs:[{name:"balance",type:"uint256"}],type:"function"},{constant:!1,inputs:[{name:"_spender",type:"address"},{name:"_value",type:"uint256"}],name:"approve",outputs:[{name:"",type:"bool"}],type:"function"}],e.abrupt("return",new web3.eth.Contract(n,t));case 8:throw e.prev=8,e.t0=e.catch(0),console.error("获取Xwawa合约失败:",e.t0),e.t0;case 12:case"end":return e.stop()}},null,null,[[0,8]])}document.addEventListener("DOMContentLoaded",function(){updateUI(),document.getElementById("connect-wallet-btn").addEventListener("click",connectWallet),document.getElementById("draw-button").addEventListener("click",startDraw),document.getElementById("draw-times-minus").addEventListener("click",function(){return updateDrawTimes(-1)}),document.getElementById("draw-times-plus").addEventListener("click",function(){return updateDrawTimes(1)}),document.getElementById("draw-times-input").addEventListener("change",validateDrawTimes),document.querySelectorAll(".close-modal, .close-result-btn").forEach(function(e){e.addEventListener("click",closeResultModal)}),initLanguageSwitch(),checkWalletConnection()});
//# sourceMappingURL=lottery.min.js.map
